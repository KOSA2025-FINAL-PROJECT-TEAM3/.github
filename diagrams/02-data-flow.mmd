sequenceDiagram
    participant Senior as ğŸ‘´ ì‹œë‹ˆì–´
    participant SeniorWeb as ì‹œë‹ˆì–´ ì›¹
    participant Gateway as API Gateway
    participant Eureka as Eureka Server
    participant MedService as Medication Service
    participant FamService as Family Service
    participant Kafka as Kafka
    participant DB as Database
    participant Hocuspocus as Hocuspocus Server
    participant CaregiverWeb as ìë…€ ì›¹
    participant Caregiver as ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ìë…€

    Note over Senior,Caregiver: ì‹œë‚˜ë¦¬ì˜¤ 1: ì•½ ë³µìš© ì²´í¬ (ì‹¤ì‹œê°„ ë™ê¸°í™”)

    Senior->>SeniorWeb: âœ… ì•½ ë³µìš© ì²´í¬
    SeniorWeb->>Gateway: POST /api/medications/logs
    Gateway->>Eureka: Service Discovery<br/>Medication Service ì¡°íšŒ
    Eureka-->>Gateway: Service Location
    Gateway->>MedService: Forward Request
    MedService->>DB: ë³µìš© ê¸°ë¡ ì €ì¥
    MedService->>Kafka: Publish MedicationLogEvent
    MedService-->>Gateway: 200 OK
    Gateway-->>SeniorWeb: Success Response

    Note over Kafka,Hocuspocus: ì‹¤ì‹œê°„ ë™ê¸°í™” ë ˆì´ì–´

    Kafka->>Hocuspocus: Consume MedicationLogEvent
    Hocuspocus->>CaregiverWeb: WebSocket Push<br/>(ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
    CaregiverWeb->>Caregiver: ğŸ”” ì•Œë¦¼: ë¶€ëª¨ë‹˜ì´ ì•½ ë“œì…¨ì–´ìš”! âœ…

    Note over Senior,Caregiver: ì‹œë‚˜ë¦¬ì˜¤ 2: ìë…€ê°€ ì›ê²©ìœ¼ë¡œ ì•½ ë“±ë¡

    Caregiver->>CaregiverWeb: ë¶€ëª¨ë‹˜ ì•½ ë“±ë¡
    CaregiverWeb->>Gateway: POST /api/medications
    Gateway->>Eureka: Service Discovery<br/>Medication Service ì¡°íšŒ
    Eureka-->>Gateway: Service Location
    Gateway->>MedService: Forward Request

    Note over MedService,FamService: ì„œë¹„ìŠ¤ ê°„ í†µì‹  (Feign Client)

    MedService->>FamService: ê°€ì¡± ê¶Œí•œ í™•ì¸<br/>GET /families/verify
    FamService->>DB: ê¶Œí•œ ì¡°íšŒ
    FamService-->>MedService: âœ… Authorized

    MedService->>DB: ì•½ ì •ë³´ ì €ì¥
    MedService->>Kafka: Publish MedicationCreatedEvent
    MedService-->>Gateway: 201 Created
    Gateway-->>CaregiverWeb: Success Response

    Kafka->>Hocuspocus: Consume MedicationCreatedEvent
    Hocuspocus->>SeniorWeb: WebSocket Push<br/>(ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
    SeniorWeb->>Senior: ğŸ“‹ ìƒˆë¡œìš´ ì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤

    Note over Senior,Caregiver: ì‹œë‚˜ë¦¬ì˜¤ 3: ì•½-ìŒì‹ ì¶©ëŒ ê²½ê³ 

    Senior->>SeniorWeb: ì‹ë‹¨ ì…ë ¥ (ìëª½ ì£¼ìŠ¤)
    SeniorWeb->>Gateway: POST /api/diets
    Gateway->>Eureka: Service Discovery<br/>Diet Service ì¡°íšŒ
    Eureka-->>Gateway: Service Location
    Gateway->>MedService: Forward to Diet Service

    MedService->>DB: ì‹ë‹¨ ì €ì¥
    MedService->>MedService: ì•½-ìŒì‹ ì¶©ëŒ ê²€ì‚¬<br/>(Rule Engine)

    alt ì¶©ëŒ ë°œê²¬
        MedService->>Kafka: Publish DrugFoodWarningEvent
        MedService-->>Gateway: 200 OK + Warning
        Gateway-->>SeniorWeb: âš ï¸ ê²½ê³  ë©”ì‹œì§€
        SeniorWeb->>Senior: ğŸš¨ ìëª½ê³¼ í˜ˆì••ì•½ ì¶©ëŒ!

        Kafka->>Hocuspocus: Consume WarningEvent
        Hocuspocus->>CaregiverWeb: WebSocket Push
        CaregiverWeb->>Caregiver: ğŸ”” ë¶€ëª¨ë‹˜ê»˜ ì•½-ìŒì‹ ì¶©ëŒ ê²½ê³  ë°œìƒ
    else ì¶©ëŒ ì—†ìŒ
        MedService-->>Gateway: 200 OK
        Gateway-->>SeniorWeb: âœ… ì•ˆì „í•œ ì‹ë‹¨
    end
